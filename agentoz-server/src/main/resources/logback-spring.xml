<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>
    <!-- 从 Nacos 读取 LogStore 配置 -->
    <springProperty scope="context" name="SLS_LOGSTORE" source="sls.logstore"/>

    <!-- 控制台输出 - 保留可读性更好的文本格式 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %level [%thread] [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 默认配置 -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>

    <!-- 生产环境启用 SLS - 使用JSON格式 -->
    <springProfile name="prod">
        <appender name="SLS" class="com.aliyun.openservices.log.logback.LoghubAppender">
            <!-- 基础配置：从系统环境变量读取 (/etc/deepknow.env) -->
            <endpoint>${SLS_ENDPOINT}</endpoint>
            <accessKeyId>${SLS_ACCESS_KEY_ID}</accessKeyId>
            <accessKeySecret>${SLS_ACCESS_KEY_SECRET}</accessKeySecret>
            <project>${SLS_PROJECT}</project>

            <!-- 业务配置：改为从环境变量读取 (需在部署脚本中注入 SLS_LOGSTORE) -->
            <logStore>${SLS_LOGSTORE}</logStore>

            <topic>${APP_NAME}</topic>
            <source>${HOSTNAME}</source>
            <totalSizeInBytes>104857600</totalSizeInBytes>
            <maxBlockMs>0</maxBlockMs>
            <ioThreadCount>8</ioThreadCount>
            <batchSizeThresholdInBytes>524288</batchSizeThresholdInBytes>
            <batchCountThreshold>4096</batchCountThreshold>
            <lingerMs>2000</lingerMs>
            <retries>10</retries>
            <baseRetryBackoffMs>100</baseRetryBackoffMs>
            <maxRetryBackoffMs>50000</maxRetryBackoffMs>

            <!-- 使用JSON encoder，SLS会自动解析字段 -->
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <!-- 自定义字段 -->
                <customFields>{"service":"deepknow","app":"${APP_NAME}"}</customFields>
                <!-- 包含MDC值（traceId、spanId等） -->
                <includeMdc>true</includeMdc>
                <!-- 包含调用者信息 -->
                <includeCallerData>false</includeCallerData>
                <!-- 使用UTC时间 -->
                <timestampPattern>yyyy-MM-dd'T'HH:mm:ss.SSS'Z'</timestampPattern>
            </encoder>

            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>INFO</level>
            </filter>
        </appender>

        <!-- 在 prod 环境下，root logger 追加 SLS -->
        <root level="INFO">
            <appender-ref ref="SLS"/>
        </root>
    </springProfile>
</configuration>
