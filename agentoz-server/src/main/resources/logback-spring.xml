<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>

    <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>
    <!-- 从 Nacos 读取 LogStore 配置 -->
    <springProperty scope="context" name="SLS_LOGSTORE" source="sls.logstore"/>

    <!-- 定义通用的日志格式，包含 TraceID -->
    <property name="LOG_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} %level [%thread] [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"/>

    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 生产环境启用 SLS -->
    <springProfile name="prod">
        <appender name="SLS" class="com.aliyun.openservices.log.logback.LoghubAppender">
            <!-- 基础配置：从系统环境变量读取 (/etc/deepknow.env) -->
            <endpoint>${SLS_ENDPOINT}</endpoint>
            <accessKeyId>${SLS_ACCESS_KEY_ID}</accessKeyId>
            <accessKeySecret>${SLS_ACCESS_KEY_SECRET}</accessKeySecret>
            <project>${SLS_PROJECT}</project>
            
            <!-- 业务配置：改为从环境变量读取 (需在部署脚本中注入 SLS_LOGSTORE) -->
            <logStore>${SLS_LOGSTORE}</logStore>
            
            <topic>${APP_NAME}</topic>
            <source>${HOSTNAME}</source>
            <totalSizeInBytes>104857600</totalSizeInBytes>
            <maxBlockMs>0</maxBlockMs>
            <ioThreadCount>8</ioThreadCount>
            <batchSizeThresholdInBytes>524288</batchSizeThresholdInBytes>
            <batchCountThreshold>4096</batchCountThreshold>
            <lingerMs>2000</lingerMs>
            <retries>10</retries>
            <baseRetryBackoffMs>100</baseRetryBackoffMs>
            <maxRetryBackoffMs>50000</maxRetryBackoffMs>
            <!-- 关键：配置 encoder 才能自定义格式 -->
            <encoder>
                <pattern>${LOG_PATTERN}</pattern>
            </encoder>
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>INFO</level>
            </filter>
        </appender>
    </springProfile>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <springProfile name="prod">
            <appender-ref ref="SLS"/>
        </springProfile>
    </root>
</configuration>