syntax = "proto3";

package codex.agent.v1;

service AgentService {
  // 执行一次代理任务
  // 输入：历史记录 + 新指令
  // 输出：执行结果 + 新增记录（流式）
  rpc RunTask (RunTaskRequest) returns (stream RunTaskResponse);

  // 全双工实时对话接口
  // 支持音频/文本流式输入，实时返回 STT 结果和 Agent 回复
  rpc RealtimeChat (stream ChatRequest) returns (stream ChatResponse);
}

message RunTaskRequest {
  string session_id = 1;

  // 代理配置 (JSON 格式，对应 SessionConfigDto)
  string config_json = 2;

  // 历史记录 (JSON 格式，对应 List<ResponseItem>)
  repeated string history_items_json = 3;

  // 用户新输入
  UserInput input = 4;
}

message UserInput {
  oneof content {
    string text = 1;
  }
}

message RunTaskResponse {
  enum Status {
    STATUS_UNSPECIFIED = 0;
    FINISHED = 1;
    NEED_USER_INPUT = 2;
    MAX_TURNS_REACHED = 3;
    ERROR = 4;
    PROCESSING = 5;
  }
  Status status = 1;
  repeated string new_items_json = 2;
  string final_response = 3;
  TokenUsage usage = 4;
  string error_message = 5;
  string text_delta = 6;
}

message TokenUsage {
  int64 prompt_tokens = 1;
  int64 completion_tokens = 2;
  int64 total_tokens = 3;
}

message ChatRequest {
  oneof payload {
    // 握手帧：客户端发送的第一条消息，包含配置
    string session_config_json = 1;

    // 音频帧：持续推送的 PCM/Opus 数据
    bytes audio_chunk = 2;

    // 文本帧：用户插话或纯文本交互
    string text_chunk = 3;
  }
}

message ChatResponse {
  oneof payload {
    // STT 中间结果 (例如 "今天...")
    string stt_intermediate = 1;

    // 智能体回答增量 (LLM Token)
    string agent_response_delta = 2;

    // 错误信息
    string error_message = 3;
  }
}