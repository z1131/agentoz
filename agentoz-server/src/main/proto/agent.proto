syntax = "proto3";

package codex.agent;

// =============================================================================
// 语言特定选项 - Language Options
// =============================================================================

// ✅ Java 专用配置 (不影响 Rust)
option java_package = "codex.agent";
option java_outer_classname = "AgentProtos";
option java_multiple_files = true;
option java_generate_equals_and_hash = true;

// =============================================================================
// 服务定义 - Service Definition
// =============================================================================

// 统一的智能体服务接口 (对齐 codex-rs/adapter)
service AgentService {
  // 执行一个智能体任务 (如代码重构、搜索验证等)
  // 这是一个服务器流式 RPC，实时返回任务执行过程中的每一个事件。
  rpc RunTask(RunTaskRequest) returns (stream RunTaskResponse);
}

// =============================================================================
// 主请求结构 (对齐 adapter.proto)
// =============================================================================

message RunTaskRequest {
  // 任务请求唯一 ID (用于链路追踪)
  string request_id = 1;

  // 会话唯一 ID (UUID)
  // 用于关联和恢复之前的会话状态 (对应原 conversation_id)
  string session_id = 2;

  // 用户指令 (Prompt)
  string prompt = 3;

  // 会话配置 (严格对齐 Codex ConfigToml 内核)
  SessionConfig session_config = 4;

  // 初始文件上下文
  repeated File context_files = 5;

  // 环境变量覆盖 (用于传递敏感 Key，如 API_KEY)
  map<string, string> env_vars = 6;

  // 基础工作目录
  string base_dir = 7;

  // 历史会话数据 (Codex 原生 JSONL 格式)
  // 如果非空，Adapter 会复活该会话并继续执行
  // ⚠️ 这是核心变化：从 repeated string history_json 改为 bytes
  bytes history_rollout = 8;
}

// =============================================================================
// SessionConfig (对齐 adapter.proto)
// =============================================================================

message SessionConfig {
  // 模型名称 (e.g., "gpt-4o", "qwen-max")
  string model = 1;

  // 模型提供商名称 (e.g., "openai", "qwen")
  string model_provider = 2;

  // 模型提供商详细配置
  ModelProviderInfo provider_info = 3;

  // 基础指令
  optional string base_instructions = 4;

  // 开发者指令 (最高优先级)
  optional string developer_instructions = 5;

  // 审批策略
  ApprovalPolicy approval_policy = 6;

  // 沙箱策略
  SandboxPolicy sandbox_policy = 7;

  // 工作目录 (绝对路径)
  string cwd = 8;

  // MCP 服务器配置 (结构化定义)
  map<string, McpServerDef> mcp_servers = 9;
}

// =============================================================================
// 模型提供商配置 (对齐 adapter.proto)
// =============================================================================

message ModelProviderInfo {
  // 提供商名称 (e.g., "openai", "qwen", "deepseek")
  string name = 1;

  // API 基础 URL (e.g., "https://dashscope.aliyuncs.com/compatible-mode/v1")
  optional string base_url = 2;

  // 环境变量 Key 名称 (用于从 env_vars 中获取 API Key)
  optional string env_key = 3;

  // 直接传递的 Bearer Token (优先级高于 env_key)
  optional string experimental_bearer_token = 4;

  // Wire API 类型
  WireApi wire_api = 5;

  // 自定义 HTTP 请求头
  map<string, string> http_headers = 6;

  // 自定义查询参数
  map<string, string> query_params = 7;

  // 是否需要 OpenAI 认证格式
  bool requires_openai_auth = 8;
}

// =============================================================================
// MCP 服务器定义 (对齐 adapter.proto)
// =============================================================================

message McpServerDef {
  // 服务类型: "stdio" 或 "streamable_http"
  string server_type = 1;

  // stdio 模式: 启动命令 (e.g., "npx", "python")
  string command = 2;

  // stdio 模式: 命令参数
  repeated string args = 3;

  // stdio 模式: 环境变量
  map<string, string> env = 4;

  // streamable_http 模式: 服务 URL
  string url = 5;
}

// =============================================================================
// 枚举定义 (对齐 adapter.proto)
// =============================================================================

enum WireApi {
  WIRE_API_CHAT = 0;
  WIRE_API_RESPONSES = 1;
  WIRE_API_RESPONSES_WEBSOCKET = 2;
}

enum ApprovalPolicy {
  APPROVAL_POLICY_UNSPECIFIED = 0;
  ALWAYS = 1;          // 总是需要审批
  NEVER = 2;           // 从不需要审批 (自动执行)
  UNLESS_TRUSTED = 3;  // 除非是受信任的操作
}

enum SandboxPolicy {
  SANDBOX_POLICY_UNSPECIFIED = 0;
  WORKSPACE_WRITE = 1;      // 仅允许写入工作区
  READ_ONLY = 2;            // 只读模式
  DANGER_FULL_ACCESS = 3;   // 危险：完全访问权限
}

// =============================================================================
// 文件上下文 (对齐 adapter.proto)
// =============================================================================

message File {
  // 相对路径 (相对于 base_dir)
  string path = 1;

  // 文件内容 (二进制)
  bytes content = 2;
}

// =============================================================================
// 响应结构 (对齐 adapter.proto - 事件驱动模式)
// =============================================================================

message RunTaskResponse {
  oneof event {
    // 原始 Codex JSONL 事件 (包含思考过程、工具调用等)
    string codex_event_json = 1;

    // 系统日志 (仅包含关键状态变迁)
    string adapter_log = 2;

    // 错误信息
    string error = 3;

    // 任务成功结束后的最新"灵魂"数据 (JSONL 格式)
    // ⚠️ 核心：这是 Agent 下次请求时需要传回的 history_rollout
    bytes updated_rollout = 4;
  }
}
