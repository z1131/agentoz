package com.deepknow.platform;

import com.deepknow.agent.sdk.AgentPlatformAPI;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

/**
 * Agent Platform 集成测试
 *
 * 测试流程：
 * 1. 使用 SDK 创建一个 Session
 * 2. 在 Session 中创建一个 Agent
 * 3. 为 Agent 挂载 WebSearch 工具
 * 4. 让 Agent 搜索"人工智能最新进展"
 * 5. 验证 Agent 是否使用了 WebSearch 并返回了结果
 *
 * 注意：此测试需要以下基础设施：
 * - MySQL 数据库（运行中）
 * - Nacos 服务注册中心（运行中）
 * - codex-agent 服务（运行中）
 */
@SpringBootTest
public class AgentPlatformIntegrationTest {
    private static final Logger log = LoggerFactory.getLogger(AgentPlatformIntegrationTest.class);


    @Autowired(required = false)
    private AgentPlatformAPI agentAPI;

    @Test
    @Disabled("需要完整的基础设施才能运行")
    public void testAgentWithWebSearch() {
        log.info("========== 开始集成测试 ==========");

        // 1. 使用 SDK 创建 Session
        String sessionId = agentAPI.createSession("test-user", "测试会话");
        log.info("✓ Session 创建成功: {}", sessionId);

        // 2. 创建 Agent（主 Agent），挂载 WebSearch 工具
        String agentId = AgentPlatformAPI.newSession("test-user")
            .title("测试会话")
            .createAgent("主Agent", "你是一个智能助手，可以使用联网搜索工具回答问题。")
            .withTools("WebSearch")
            .build();

        log.info("✓ Agent 创建成功: {}", agentId);

        // 3. 让 Agent 搜索"人工智能最新进展"
        String query = "人工智能最新进展";
        log.info("让 Agent 搜索: {}", query);

        String response = agentAPI.chat(agentId, query);
        log.info("✓ Agent 搜索完成");

        log.info("========== 搜索结果 ==========");
        log.info(response);
        log.info("========== 测试结束 ==========");

        // 4. 验证结果
        verifyResponse(response);
    }

    @Test
    @Disabled("需要完整的基础设施才能运行")
    public void testSimpleConversation() {
        log.info("========== 测试简单对话 ==========");

        // 创建 Session 和 Agent
        String agentId = AgentPlatformAPI.newSession("test-user")
            .title("简单对话测试")
            .createAgent("助手", "你是一个友好的助手。")
            .build();

        // 发送消息
        String response = agentAPI.chat(agentId, "你好，请介绍一下你自己。");

        log.info("Agent 回复: {}", response);

        // 验证
        if (response != null && !response.isEmpty()) {
            log.info("✓ 测试通过");
        } else {
            log.error("✗ 测试失败：Agent 没有回复");
        }
    }

    /**
     * 验证响应
     */
    private void verifyResponse(String response) {
        if (response == null || response.isEmpty()) {
            log.error("✗ 验证失败：Agent 没有返回搜索结果");
            return;
        }

        // 简单验证：响应不为空
        log.info("✓ 验证通过：Agent 返回了搜索结果");

        // TODO: 更详细的验证
        // 1. 检查是否包含搜索结果的格式（如"联网搜索结果"）
        // 2. 检查调用日志中是否记录了 WebSearch 的调用
    }
}
